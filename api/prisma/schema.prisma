generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ====================================================
// 0. –°–ü–†–ê–í–û–ß–ù–ò–ö–ò (TOKENS, ENUMS)
// ====================================================

model CryptoToken {
    id                  Int                  @id @default(autoincrement())
    
    symbol              String               @unique
    name                String
    network             String               @default("ERC-20") 
    decimals            Int
    createdAt           DateTime             @default(now())

    // –°–≤—è–∑–∏
    crashBets           CrashBet[]           @relation("CrashTokenBets")
    crashTransactions   CrashTransaction[]   @relation("CrashTransactionTokens")
    minesweeperGames    MinesweeperGame[]    @relation("MinesweeperTokens")
    minesweeperBets     MinesweeperBet[]     @relation("MinesweeperBetTokens")
    balances            Balance[]
    transactions        Transaction[]
    bets                Bet[]
    leaderboard         LeaderboardEntry[]
    userBonuses         UserBonus[]
    referralCommissions ReferralTransaction[]
    referralStats       ReferralStats[]
}

enum GameType {
    SLOT
    ROULETTE
    BLACKJACK
    CRASH
    LIVE_DEALER
    MINESWEEPER
}

enum TransactionType {
    DEPOSIT
    WITHDRAW
    BONUS
    REFUND
    TRANSFER
    REFERRAL_COMMISSION
    BONUS_TO_MAIN
}

enum TransactionStatus {
    PENDING
    COMPLETED
    FAILED
}

enum BalanceType {
    MAIN
    BONUS
}

enum ReferralEventType {
    BET_COMMISSION
    DEPOSIT_BONUS
}

// üÜï –¢–∏–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (–æ–±—ã—á–Ω—ã–π –∏–ª–∏ –≤–æ—Ä–∫–µ—Ä)
enum ReferrerType {
    REGULAR
    WORKER
}

// ====================================================
// 1. –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò (USERS)
// ====================================================

model User {
    id                  Int                @id @default(autoincrement())
    telegramId          String             @unique
    username            String?            @unique
    firstName           String?
    lastName            String?
    photoUrl            String?
    passwordHash        String?
    salt                String?
    isAdmin             Boolean            @default(false)
    isBlocked           Boolean            @default(false)
    
    createdAt           DateTime           @default(now())
    updatedAt           DateTime           @updatedAt

    // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
    referralCode        String             @unique @default(cuid()) 
    referredById        Int?               
    referrer            User?              @relation("UserReferrals", fields: [referredById], references: [id])
    referrals           User[]             @relation("UserReferrals") 
    
    // üÜï –¢–∏–ø —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ (–æ–±—ã—á–Ω—ã–π 30% –∏–ª–∏ –≤–æ—Ä–∫–µ—Ä 40%)
    referrerType        ReferrerType       @default(REGULAR)

    // –°–≤—è–∑–∏
    crashBets           CrashBet[]         @relation("CrashBets")
    crashTransactions   CrashTransaction[] @relation("CrashTransactions")
    minesweeperGames    MinesweeperGame[]  @relation("MinesweeperGames")
    minesweeperBets     MinesweeperBet[]   @relation("MinesweeperBets")
    balances            Balance[]
    transactions        Transaction[]
    bets                Bet[]
    leaderboardEntries  LeaderboardEntry[]
    bonuses             UserBonus[]
    commissions         ReferralTransaction[] 
    referralActions     ReferralTransaction[] @relation("RefereeActions")
    authTokens          OneTimeToken[]
    
    // üÜï –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–∫–∞–∫ —Ä–µ—Ñ–µ—Ä–µ—Ä)
    referralStatsAsReferrer  ReferralStats[] @relation("ReferrerStats")
    // üÜï –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–∫–∞–∫ —Ä–µ—Ñ–µ—Ä–∞–ª)
    referralStatsAsReferee   ReferralStats[] @relation("RefereeStats")
}

// ====================================================
// 2. –§–ò–ù–ê–ù–°–´ –ò –ë–ê–õ–ê–ù–° (BALANCE)
// ====================================================

model Balance {
    id              Int           @id @default(autoincrement())
    
    userId          Int
    user            User          @relation(fields: [userId], references: [id])
    
    tokenId         Int
    token           CryptoToken   @relation(fields: [tokenId], references: [id])
    
    type            BalanceType   @default(MAIN)
    amount          Decimal       @default(0.0) @db.Decimal(30, 18) 
    
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt
    
    @@unique([userId, tokenId, type]) 
}

// ====================================================
// 3. –¢–†–ê–ù–ó–ê–ö–¶–ò–ò (–í–≤–æ–¥/–í—ã–≤–æ–¥)
// ====================================================

model Transaction {
    id              Int                 @id @default(autoincrement())
    
    userId          Int
    user            User                @relation(fields: [userId], references: [id])
    
    tokenId         Int
    token           CryptoToken         @relation(fields: [tokenId], references: [id])

    type            TransactionType
    status          TransactionStatus   @default(PENDING)
    
    amount          Decimal             @db.Decimal(30, 18)
    
    txHash          String?             
    walletAddress   String?             
    
    createdAt       DateTime            @default(now())
    updatedAt       DateTime            @updatedAt
    
    @@unique([txHash, userId], map: "Transaction_txHash_userId_key")
}

// ====================================================
// 4. –°–¢–ê–í–ö–ò –ò –ò–ì–†–´ (BETS)
// ====================================================

model Bet {
    id              Int         @id @default(autoincrement())
    
    userId          Int
    user            User        @relation(fields: [userId], references: [id])
    
    tokenId         Int 
    token           CryptoToken @relation(fields: [tokenId], references: [id])
    
    gameType        GameType
    
    betAmount       Decimal     @db.Decimal(30, 18)
    payoutAmount    Decimal     @db.Decimal(30, 18)
    netAmount       Decimal     @db.Decimal(30, 18)
    
    payoutRatio     Float
    roundId         String
    details         Json?       
    
    createdAt       DateTime    @default(now())
    
    @@index([userId, gameType, createdAt])
}

// ====================================================
// 5. –ë–û–ù–£–°–´ –ò –û–¢–´–ì–†–´–® (GAMING LOGIC)
// ====================================================

model Bonus {
    id                   Int         @id @default(autoincrement())
    name                 String      @unique
    description          String
    wageringMultiplier   Float       
    maxBonusAmount       Decimal     @db.Decimal(30, 18)
    
    // üÜï –ü—Ä–æ—Ü–µ–Ω—Ç –±–æ–Ω—É—Å–∞ –∫ –¥–µ–ø–æ–∑–∏—Ç—É (100 = +100%)
    depositBonusPercent  Float       @default(0)
    
    userBonuses          UserBonus[]
}

model UserBonus {
    id              Int       @id @default(autoincrement())
    
    userId          Int
    user            User      @relation(fields: [userId], references: [id])
    
    bonusId         Int
    bonus           Bonus     @relation(fields: [bonusId], references: [id])
    
    tokenId         Int
    token           CryptoToken @relation(fields: [tokenId], references: [id])
    
    grantedAmount   Decimal   @db.Decimal(30, 18)
    requiredWager   Decimal   @db.Decimal(30, 18)
    wageredAmount   Decimal   @default(0.0) @db.Decimal(30, 18)
    
    isActive        Boolean   @default(true)
    isCompleted     Boolean   @default(false)
    
    // üÜï ID —Ä–µ—Ñ–µ—Ä–µ—Ä–∞ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≤—ë–ª —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è)
    referrerId      Int?
    
    createdAt       DateTime  @default(now())
    expiresAt       DateTime?
    
    @@unique([userId, bonusId, tokenId])
}

// ====================================================
// 6. –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í (LEADERBOARD)
// ====================================================

model LeaderboardEntry {
    id          Int          @id @default(autoincrement())
    
    userId      Int          
    user        User         @relation(fields: [userId], references: [id])
    
    tokenId     Int?         
    token       CryptoToken? @relation(fields: [tokenId], references: [id])
    
    metric      String
    score       Decimal      @db.Decimal(30, 18)
    period      String
    
    updatedAt   DateTime     @updatedAt
    
    @@unique([userId, metric, period, tokenId])
    @@index([metric, period, score(sort: Desc)])
}

// ====================================================
// 7. –†–ï–§–ï–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê (REFERRAL TRANSACTIONS)
// ====================================================

model ReferralTransaction {
    id              Int                 @id @default(autoincrement())
    
    referrerId      Int
    referrer        User                @relation(fields: [referrerId], references: [id])

    refereeId       Int
    referee         User                @relation("RefereeActions", fields: [refereeId], references: [id])

    tokenId         Int
    token           CryptoToken         @relation(fields: [tokenId], references: [id])

    eventType       ReferralEventType   
    
    amount          Decimal             @db.Decimal(30, 18) 
    
    sourceEntityId  Int                 
    sourceEntityType String
    
    createdAt       DateTime            @default(now())
    
    @@index([referrerId, createdAt]) 
}

// ====================================================
// üÜï 8. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ï–§–ï–†–ê–õ–û–í (–ê–ö–ö–£–ú–£–õ–ò–†–û–í–ê–ù–ù–´–ô –û–ë–û–†–û–¢)
// ====================================================

model ReferralStats {
    id                      Int       @id @default(autoincrement())
    
    // –†–µ—Ñ–µ—Ä–µ—Ä (–∫—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–∏—Å—Å–∏—é)
    referrerId              Int
    referrer                User      @relation("ReferrerStats", fields: [referrerId], references: [id])
    
    // –†–µ—Ñ–µ—Ä–∞–ª (–∫—Ç–æ –∏–≥—Ä–∞–µ—Ç)
    refereeId               Int
    referee                 User      @relation("RefereeStats", fields: [refereeId], references: [id])
    
    // –¢–æ–∫–µ–Ω
    tokenId                 Int
    token                   CryptoToken @relation(fields: [tokenId], references: [id])
    
    // –û–±—â–∏–π –æ–±–æ—Ä–æ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–∞
    totalTurnover           Decimal   @default(0) @db.Decimal(30, 18)
    
    // –û–±–æ—Ä–æ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–ø–ª–∞—Ç—ã (–æ–±–Ω—É–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–ª–∞—Ç—ã –∫–æ–º–∏—Å—Å–∏–∏)
    turnoverSinceLastPayout Decimal   @default(0) @db.Decimal(30, 18)
    
    // –û–±—â–∞—è —Å—É–º–º–∞ –≤—ã–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π
    totalCommissionPaid     Decimal   @default(0) @db.Decimal(30, 18)
    
    // –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–ø–ª–∞—Ç—ã
    lastPayoutAt            DateTime?
    
    createdAt               DateTime  @default(now())
    updatedAt               DateTime  @updatedAt
    
    // –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è: –æ–¥–∏–Ω —Ä–µ—Ñ–µ—Ä–µ—Ä + –æ–¥–∏–Ω —Ä–µ—Ñ–µ—Ä–∞–ª + –æ–¥–∏–Ω —Ç–æ–∫–µ–Ω
    @@unique([referrerId, refereeId, tokenId])
    
    // –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
    @@index([referrerId])
    @@index([refereeId])
    @@index([turnoverSinceLastPayout])
}

// ====================================================
// 9. –û–î–ù–û–†–ê–ó–û–í–´–ï –¢–û–ö–ï–ù–´ (ONE-TIME AUTHS)
// ====================================================

model OneTimeToken {
    id              Int      @id @default(autoincrement())
    
    token           String   @unique
    
    userId          Int
    user            User     @relation(fields: [userId], references: [id])
    
    createdAt       DateTime @default(now())
    
    expiresAt       DateTime 
    
    used            Boolean  @default(false)
    
    @@index([token, expiresAt])
}

// ====================================================
// 10. CRASH GAME SPECIFIC MODELS
// ====================================================

model CrashRound {
    id                Int          @id @default(autoincrement())
    
    gameId            String       @unique
    crashPoint        Decimal      @db.Decimal(10, 2)
    
    totalPlayers      Int          @default(0)
    winnersCount      Int          @default(0)
    
    totalWagered      Decimal      @default(0) @db.Decimal(30, 18)
    totalPayouts      Decimal      @default(0) @db.Decimal(30, 18)
    
    serverSeedHash    String       @unique
    clientSeed        String
    nonce             Int          @default(0)
    
    createdAt         DateTime     @default(now())
    updatedAt         DateTime     @updatedAt
    
    bets              CrashBet[]
    
    @@index([gameId])
    @@index([createdAt])
}

model CrashBet {
    id               Int                @id @default(autoincrement())
    
    roundId          Int
    round            CrashRound         @relation(fields: [roundId], references: [id], onDelete: Cascade)
    
    userId           Int
    user             User               @relation("CrashBets", fields: [userId], references: [id], onDelete: Cascade)
    
    tokenId          Int
    token            CryptoToken        @relation("CrashTokenBets", fields: [tokenId], references: [id])
    
    betAmount        Decimal            @db.Decimal(30, 18)
    exitMultiplier   Decimal?           @db.Decimal(10, 2)
    winnings         Decimal?           @default(0) @db.Decimal(30, 18)
    result           String
    
    createdAt        DateTime           @default(now())

    transactions     CrashTransaction[]

    @@index([userId, createdAt])
    @@index([roundId])
    @@index([result])
}

model CrashTransaction {
    id          Int         @id @default(autoincrement())
    
    userId      Int
    user        User        @relation("CrashTransactions", fields: [userId], references: [id])
    
    betId       Int?
    bet         CrashBet?   @relation(fields: [betId], references: [id])
    
    tokenId     Int
    token       CryptoToken @relation("CrashTransactionTokens", fields: [tokenId], references: [id])
    
    amount      Decimal     @db.Decimal(30, 18)
    
    type        String
    
    createdAt   DateTime    @default(now())
    
    @@index([userId, createdAt])
}

// ====================================================
// 11. MINESWEEPER GAME MODELS
// ====================================================

model MinesweeperDifficulty {
    id              Int                 @id @default(autoincrement())
    
    name            String              @unique
    minesCount      Int
    gridSize        Int                 @default(6)
    multiplier      Float
    
    games           MinesweeperGame[]
    
    createdAt       DateTime            @default(now())
}

model MinesweeperGame {
    id              Int                 @id @default(autoincrement())
    
    userId          Int
    user            User                @relation("MinesweeperGames", fields: [userId], references: [id], onDelete: Cascade)
    
    tokenId         Int
    token           CryptoToken         @relation("MinesweeperTokens", fields: [tokenId], references: [id])
    
    difficultyId    Int
    difficulty      MinesweeperDifficulty @relation(fields: [difficultyId], references: [id])
    
    gameState       Json
    minesPositions  Json
    
    status          String              @default("PLAYING")
    revealedCells   Int                 @default(0)
    flaggedCells    Int                 @default(0)
    
    betAmount       Decimal             @db.Decimal(30, 18)
    winAmount       Decimal?            @db.Decimal(30, 18)
    multiplier      Float               @default(1.0)
    
    createdAt       DateTime            @default(now())
    updatedAt       DateTime            @updatedAt
    
    @@index([userId, createdAt])
    @@index([status])
}
model PendingDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  invoiceId String   @unique
  amount    Float
  asset     String   @default("USDT")
  status    String   @default("pending") // pending | processed | expired | canceled
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status, createdAt])
}
model MinesweeperBet {
    id              Int                 @id @default(autoincrement())
    
    userId          Int
    user            User                @relation("MinesweeperBets", fields: [userId], references: [id], onDelete: Cascade)
    
    tokenId         Int
    token           CryptoToken         @relation("MinesweeperBetTokens", fields: [tokenId], references: [id])
    
    gameId          Int
    
    betAmount       Decimal             @db.Decimal(30, 18)
    winAmount       Decimal?            @db.Decimal(30, 18)
    
    result          String
    multiplier      Float
    
    createdAt       DateTime            @default(now())
    
    @@index([userId, createdAt])
}
