generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ====================================================
// 0. СПРАВОЧНИКИ (TOKENS, ENUMS)
// ====================================================

model CryptoToken {
    id                  Int                  @id @default(autoincrement())
    
    symbol              String               @unique
    name                String
    network             String               @default("ERC-20") 
    decimals            Int
    createdAt           DateTime             @default(now())

    // Связи
    crashBets           CrashBet[]           @relation("CrashTokenBets")
    crashTransactions   CrashTransaction[]   @relation("CrashTransactionTokens")
    minesweeperGames    MinesweeperGame[]    @relation("MinesweeperTokens")
    minesweeperBets     MinesweeperBet[]     @relation("MinesweeperBetTokens")
    balances            Balance[]
    transactions        Transaction[]
    bets                Bet[]
    leaderboard         LeaderboardEntry[]
    userBonuses         UserBonus[]
    referralCommissions ReferralTransaction[]
}

enum GameType {
    SLOT
    ROULETTE
    BLACKJACK
    CRASH
    LIVE_DEALER
    MINESWEEPER
}

enum TransactionType {
    DEPOSIT
    WITHDRAW
    BONUS
    REFUND
    TRANSFER
}

enum TransactionStatus {
    PENDING
    COMPLETED
    FAILED
}

enum BalanceType {
    MAIN
    BONUS
}

enum ReferralEventType {
    BET_COMMISSION
    DEPOSIT_BONUS
}

// ====================================================
// 1. АУТЕНТИФИКАЦИЯ И ПОЛЬЗОВАТЕЛИ (USERS)
// ====================================================

model User {
    id                  Int                @id @default(autoincrement())
    telegramId          String             @unique
    username            String?            @unique
    firstName           String?
    lastName            String?
    photoUrl            String?
    passwordHash        String?
    salt                String?
    isAdmin             Boolean            @default(false)
    isBlocked           Boolean            @default(false)
    
    createdAt           DateTime           @default(now())
    updatedAt           DateTime           @updatedAt

    // Реферальная система
    referralCode        String             @unique @default(cuid()) 
    referredById        Int?               
    referrer            User?              @relation("UserReferrals", fields: [referredById], references: [id])
    referrals           User[]             @relation("UserReferrals") 

    // Связи
    crashBets           CrashBet[]         @relation("CrashBets")
    crashTransactions   CrashTransaction[] @relation("CrashTransactions")
    minesweeperGames    MinesweeperGame[]  @relation("MinesweeperGames")
    minesweeperBets     MinesweeperBet[]   @relation("MinesweeperBets")
    balances            Balance[]
    transactions        Transaction[]
    bets                Bet[]
    leaderboardEntries  LeaderboardEntry[]
    bonuses             UserBonus[]
    commissions         ReferralTransaction[] 
    referralActions     ReferralTransaction[] @relation("RefereeActions")
    authTokens          OneTimeToken[] 
}

// ====================================================
// 2. ФИНАНСЫ И БАЛАНС (BALANCE)
// ====================================================

model Balance {
    id              Int           @id @default(autoincrement())
    
    userId          Int
    user            User          @relation(fields: [userId], references: [id])
    
    tokenId         Int
    token           CryptoToken   @relation(fields: [tokenId], references: [id])
    
    type            BalanceType   @default(MAIN)
    amount          Decimal       @default(0.0) @db.Decimal(30, 18) 
    
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt
    
    @@unique([userId, tokenId, type]) 
}

// ====================================================
// 3. ТРАНЗАКЦИИ (Ввод/Вывод)
// ====================================================

model Transaction {
    id              Int                 @id @default(autoincrement())
    
    userId          Int
    user            User                @relation(fields: [userId], references: [id])
    
    tokenId         Int
    token           CryptoToken         @relation(fields: [tokenId], references: [id])

    type            TransactionType
    status          TransactionStatus   @default(PENDING)
    
    amount          Decimal             @db.Decimal(30, 18)
    
    txHash          String?             
    walletAddress   String?             
    
    createdAt       DateTime            @default(now())
    updatedAt       DateTime            @updatedAt
    
    @@unique([txHash, userId], map: "Transaction_txHash_userId_key")
}

// ====================================================
// 4. СТАВКИ И ИГРЫ (BETS)
// ====================================================

model Bet {
    id              Int         @id @default(autoincrement())
    
    userId          Int
    user            User        @relation(fields: [userId], references: [id])
    
    tokenId         Int 
    token           CryptoToken @relation(fields: [tokenId], references: [id])
    
    gameType        GameType
    
    betAmount       Decimal     @db.Decimal(30, 18)
    payoutAmount    Decimal     @db.Decimal(30, 18)
    netAmount       Decimal     @db.Decimal(30, 18)
    
    payoutRatio     Float
    roundId         String
    details         Json?       
    
    createdAt       DateTime    @default(now())
    
    @@index([userId, gameType, createdAt])
}

// ====================================================
// 5. БОНУСЫ И ОТЫГРЫШ (GAMING LOGIC)
// ====================================================

model Bonus {
    id                   Int         @id @default(autoincrement())
    name                 String      @unique
    description          String
    wageringMultiplier   Float       
    maxBonusAmount       Decimal     @db.Decimal(30, 18)
    
    userBonuses          UserBonus[]
}

model UserBonus {
    id              Int       @id @default(autoincrement())
    
    userId          Int
    user            User      @relation(fields: [userId], references: [id])
    
    bonusId         Int
    bonus           Bonus     @relation(fields: [bonusId], references: [id])
    
    tokenId         Int
    token           CryptoToken @relation(fields: [tokenId], references: [id])
    
    grantedAmount   Decimal   @db.Decimal(30, 18)
    requiredWager   Decimal   @db.Decimal(30, 18)
    wageredAmount   Decimal   @default(0.0) @db.Decimal(30, 18)
    
    isActive        Boolean   @default(true)
    isCompleted     Boolean   @default(false)
    
    createdAt       DateTime  @default(now())
    expiresAt       DateTime?
    
    @@unique([userId, bonusId, tokenId])
}

// ====================================================
// 6. ТАБЛИЦА ЛИДЕРОВ (LEADERBOARD)
// ====================================================

model LeaderboardEntry {
    id          Int          @id @default(autoincrement())
    
    userId      Int          
    user        User         @relation(fields: [userId], references: [id])
    
    tokenId     Int?         
    token       CryptoToken? @relation(fields: [tokenId], references: [id])
    
    metric      String
    score       Decimal      @db.Decimal(30, 18)
    period      String
    
    updatedAt   DateTime     @updatedAt
    
    @@unique([userId, metric, period, tokenId])
    @@index([metric, period, score(sort: Desc)])
}

// ====================================================
// 7. РЕФЕРАЛЬНАЯ СИСТЕМА (REFERRAL TRANSACTIONS)
// ====================================================

model ReferralTransaction {
    id              Int                 @id @default(autoincrement())
    
    referrerId      Int
    referrer        User                @relation(fields: [referrerId], references: [id])

    refereeId       Int
    referee         User                @relation("RefereeActions", fields: [refereeId], references: [id])

    tokenId         Int
    token           CryptoToken         @relation(fields: [tokenId], references: [id])

    eventType       ReferralEventType   
    
    amount          Decimal             @db.Decimal(30, 18) 
    
    sourceEntityId  Int                 
    sourceEntityType String
    
    createdAt       DateTime            @default(now())
    
    @@index([referrerId, createdAt]) 
}

// ====================================================
// 8. ОДНОРАЗОВЫЕ ТОКЕНЫ (ONE-TIME AUTHS)
// ====================================================
model OneTimeToken {
    id              Int      @id @default(autoincrement())
    
    token           String   @unique
    
    userId          Int
    user            User     @relation(fields: [userId], references: [id])
    
    createdAt       DateTime @default(now())
    
    expiresAt       DateTime 
    
    used            Boolean  @default(false)
    
    @@index([token, expiresAt])
}

// ====================================================
// 9. CRASH GAME SPECIFIC MODELS
// ====================================================
model CrashRound {
    id                Int          @id @default(autoincrement())
    
    gameId            String       @unique
    crashPoint        Decimal      @db.Decimal(10, 2)
    
    totalPlayers      Int          @default(0)
    winnersCount      Int          @default(0)
    
    totalWagered      Decimal      @default(0) @db.Decimal(30, 18)
    totalPayouts      Decimal      @default(0) @db.Decimal(30, 18)
    
    serverSeedHash    String       @unique
    clientSeed        String
    nonce             Int          @default(0)
    
    createdAt         DateTime     @default(now())
    updatedAt         DateTime     @updatedAt
    
    bets              CrashBet[]
    
    @@index([gameId])
    @@index([createdAt])
}

model CrashBet {
    id               Int                @id @default(autoincrement())
    
    roundId          Int
    round            CrashRound         @relation(fields: [roundId], references: [id], onDelete: Cascade)
    
    userId           Int
    user             User               @relation("CrashBets", fields: [userId], references: [id], onDelete: Cascade)
    
    tokenId          Int
    token            CryptoToken        @relation("CrashTokenBets", fields: [tokenId], references: [id])
    
    betAmount        Decimal            @db.Decimal(30, 18)
    exitMultiplier   Decimal?           @db.Decimal(10, 2)
    winnings         Decimal?           @default(0) @db.Decimal(30, 18)
    result           String
    
    createdAt        DateTime           @default(now())

    transactions     CrashTransaction[]

    @@index([userId, createdAt])
    @@index([roundId])
    @@index([result])
}

model CrashTransaction {
    id          Int         @id @default(autoincrement())
    
    userId      Int
    user        User        @relation("CrashTransactions", fields: [userId], references: [id])
    
    betId       Int?
    bet         CrashBet?   @relation(fields: [betId], references: [id])
    
    tokenId     Int
    token       CryptoToken @relation("CrashTransactionTokens", fields: [tokenId], references: [id])
    
    amount      Decimal     @db.Decimal(30, 18)
    
    type        String
    
    createdAt   DateTime    @default(now())
    
    @@index([userId, createdAt])
}

// ====================================================
// 10. MINESWEEPER GAME MODELS
// ====================================================

model MinesweeperDifficulty {
    id              Int                 @id @default(autoincrement())
    
    name            String              @unique
    minesCount      Int
    gridSize        Int                 @default(6)
    multiplier      Float
    
    games           MinesweeperGame[]
    
    createdAt       DateTime            @default(now())
}

model MinesweeperGame {
    id              Int                 @id @default(autoincrement())
    
    userId          Int
    user            User                @relation("MinesweeperGames", fields: [userId], references: [id], onDelete: Cascade)
    
    tokenId         Int
    token           CryptoToken         @relation("MinesweeperTokens", fields: [tokenId], references: [id])
    
    difficultyId    Int
    difficulty      MinesweeperDifficulty @relation(fields: [difficultyId], references: [id])
    
    gameState       Json
    minesPositions  Json
    
    status          String              @default("PLAYING")
    revealedCells   Int                 @default(0)
    flaggedCells    Int                 @default(0)
    
    betAmount       Decimal             @db.Decimal(30, 18)
    winAmount       Decimal?            @db.Decimal(30, 18)
    multiplier      Float               @default(1.0)
    
    createdAt       DateTime            @default(now())
    updatedAt       DateTime            @updatedAt
    
    @@index([userId, createdAt])
    @@index([status])
}

model MinesweeperBet {
    id              Int                 @id @default(autoincrement())
    
    userId          Int
    user            User                @relation("MinesweeperBets", fields: [userId], references: [id], onDelete: Cascade)
    
    tokenId         Int
    token           CryptoToken         @relation("MinesweeperBetTokens", fields: [tokenId], references: [id])
    
    gameId          Int
    
    betAmount       Decimal             @db.Decimal(30, 18)
    winAmount       Decimal?            @db.Decimal(30, 18)
    
    result          String
    multiplier      Float
    
    createdAt       DateTime            @default(now())
    
    @@index([userId, createdAt])
}